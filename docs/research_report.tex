\documentclass[a4paper,12pt]{article}

\usepackage[utf8]{inputenc}
\usepackage[japanese]{babel}
\usepackage[top=20mm, bottom=25mm, left=20mm, right=20mm]{geometry}
\usepackage{url}
\usepackage[dvipdfmx]{graphicx}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{booktabs}
\usepackage{float}
\usepackage{multirow}

\title{太陽光発電・蓄電池システムにおける\\ローリング計画法による電気料金最小化}
\author{神戸大学工学部情報知能工学科4年\\山崎博之}
\date{2025年12月28日}

\begin{document}

\maketitle

\section{背景と目的}

北海道十勝地方に設置されたPV（太陽光発電）・蓄電池システム（PV容量250kW）を対象に，ローリング計画法を用いて，年間電気料金の最小化を図った．2024年1月1日から12月31日（2月29日を除く365日）の実データとして，施設の消費電力データ，PV発電量データ，およびJEPX（日本卸電力取引所）のスポット価格データを使用した（17,520ステップ，30分間隔）．北海道電力の基本プラン（高圧電力）と市場価格連動プランの2つの料金体系を対象とし，蓄電池容量を0kWh〜1720kWhの範囲で変化させてシミュレーションを実施した．最適化には混合整数線形計画法（MILP）ソルバーPySCIPOptを使用し，96ステップ（48時間先）の予測期間を用いて計算を実行した．

本研究の目的は以下の通りである：
\begin{enumerate}
    \item PV・蓄電池システムのローリング計画法を構築・実装し，2024年の実データを用いて年間電気料金の最小化を図る．
    \item \textbf{蓄電池容量と料金プラン選択}：蓄電池容量を0kWh〜1720kWhの範囲で変化させ，各容量における北海道電力基本プラン（固定料金）と市場価格連動プラン（JEPX連動）の経済性を比較する．さらに，各プランにとって最適な蓄電池容量で公平な比較を行い，どちらのプランが有利かを検証する．
    \item \textbf{予測期間の影響}：ローリング計画法における予測期間を24時間，48時間，72時間で比較し，予測期間の長さが蓄電池運用や経済性に与える影響を分析する．
\end{enumerate}

\section{システム構成と制約条件}

\subsection{導入システムの仕様}

本研究で対象とするシステムの仕様は以下の通りである：

\begin{itemize}
    \item \textbf{期間}：2024年1月1日から12月31日(2月29日を除く365日,17,520ステップ,30分間隔)
    \item \textbf{太陽光発電システム}
    \begin{itemize}
        \item PV容量：250 kW
        \item パネル設置方向：南向き
        \item パネル設置角度：40°
    \end{itemize}
    \item \textbf{蓄電池システム}
    \begin{itemize}
        \item 蓄電池容量：860 kWh (430 kWh $\times$ 2)
        \item 充放電最大出力：400 kW
        \item SOC初期値：430 kWh (50\%)
        \item 充電効率：0.98（仮定値）
        \item 放電効率：0.98（仮定値）
    \end{itemize}
    \item \textbf{系統電力}
    \begin{itemize}
        \item 系統買電単価：市場価格連動（JEPX）または固定料金
        \item 基本料金単価：2,829.60円/kW（北海道電力高圧電力）
        \item 力率割引：85\%（基本料金15\%割引）
        \item 売電：不可（売電量 = 0）
    \end{itemize}
\end{itemize}

\subsection{制約条件}

システム運用における主な制約条件は以下の通りである：

\begin{itemize}
    \item \textbf{電力収支制約}：各時刻において，PV発電量 + 買電量 + 蓄電池放電量 = 需要 + 蓄電池充電量
    \item \textbf{蓄電池SOC制約}：$43 \leq \text{SOC}(t) \leq 817$ kWh（全容量860kWhの5\%〜95\%の範囲で運用）
    \item \textbf{充放電出力制約}：充電・放電それぞれ最大400 kW
    \item \textbf{売電禁止制約}：売電量 = 0（PV余剰電力は不使用）
    \item \textbf{非同時充放電制約}：同一時刻に充電と放電を同時に行わない
\end{itemize}


\section{最適化手法}

\subsection{ローリング計画法の概要}

本研究では，ローリング計画法を採用した．まず，時間軸 $t$ を 0.5 時間（30 分）ごとの等間隔グリッドで離散化し，各離散時刻を整数インデックス $k \in \mathbb{Z}$（$k=0,1,2,\dots$）で表す．「ステップ」はこの離散時刻の一単位を意味し，時刻 $k$ と時刻 $k+1$ の間隔が現実世界の 30 分に相当する．ここで，$\Delta t = 0.5$ 時間（30分）を時間刻み幅とする．

各時刻区間 $[k\Delta t,(k+1)\Delta t)$ 内では，買電量や充放電電力などの\textbf{制御変数}が区間全体で一定であると仮定し，区間境界における値が最適化で決まる．ここで制御変数とは，システムを制御するために決定すべき変数を指し，本研究では以下が該当する：
\begin{itemize}
    \item \textbf{買電量} $s^{\mathrm{BY}}_{k}$：系統からどれだけ電力を購入するか
    \item \textbf{充電電力} $x^{\mathrm{FC}}_{k}$：蓄電池にどれだけ充電するか
    \item \textbf{放電電力} $x^{\mathrm{FD}}_{k}$：蓄電池からどれだけ放電するか
\end{itemize}
これらに対し，需要やPV発電量は外部環境によって決まるため制御できず，「外生変数」と呼ばれる．PV発電の余剰（不使用）は不等式制約により自動的に調整される．最適化の目的は，外生変数が与えられた状況で，制御変数を適切に決定して電気料金を最小化することである．

\subsubsection{ローリング計画法の基本概念}

ローリング計画法では，固定長の予測期間（ホライズン）を時間経過とともに前方に「転がして（rolling）」いく．1年間全体（17,520ステップ）を一度に最適化するのではなく，以下のように分割して実行する：

\begin{itemize}
    \item \textbf{第1回最適化}：時刻0から時刻95まで（96ステップ = 48時間）を最適化 → 時刻0の制御入力のみ実行
    \item \textbf{第2回最適化}：時刻1から時刻96まで（96ステップ = 48時間）を最適化 → 時刻1の制御入力のみ実行
    \item \textbf{第3回最適化}：時刻2から時刻97まで（96ステップ = 48時間）を最適化 → 時刻2の制御入力のみ実行
    \item $\vdots$
    \item \textbf{第17,520回最適化}：時刻17,519から時刻17,614まで（96ステップ）を最適化 → 時刻17,519の制御入力のみ実行
\end{itemize}

このように，予測期間を1ステップずつ前進させながら最適化を繰り返す．

\subsubsection{ローリング計画法の利点}

\begin{enumerate}
    \item \textbf{計算負荷の軽減}：17,520ステップ全体を一度に最適化する場合，変数数が膨大となり計算が困難である．96ステップごとの最適化に分割することで，各最適化問題のサイズを実用的な範囲に抑えられる．

    \item \textbf{最新情報の反映}：各時刻で最新のシステム状態（蓄電池SOC，気象予報など）を反映できる．実運用では予測誤差が生じるため，定期的に最適化を再計算することで精度が向上する．

    \item \textbf{不確実性への対応}：将来の需要やPV発電は完全には予測できないため，予測期間を限定（48時間先まで）し，新しい情報が得られるたびに計画を更新する方が現実的である．
\end{enumerate}

\subsubsection{ローリング計画法の実行手順}

ローリング計画法は以下の手順で実行される：

\begin{enumerate}
    \item 現在時刻 $k$ から将来 $k+H-1$ までの $H$ ステップ（計 $H\Delta t$ 時間）の予測期間を設定
    \item 予測期間内のすべての制御変数列を含む最適化問題を解く
    \item 解から得られた最初の1ステップ分（区間 $[k\Delta t, (k+1)\Delta t)$ に対応）の制御変数のみを実行
    \item 時刻インデックスを $k \leftarrow k+1$ と更新し，上記を繰り返す
\end{enumerate}

ここで，各制御変数（買電量 $s^{\mathrm{BY}}_{k}$，充放電電力 $x^{\mathrm{FC}}_{k},x^{\mathrm{FD}}_{k}$ など）は区間 $[k\Delta t,(k+1)\Delta t)$ 内で一定と仮定する．本研究では，$H = 96$（48時間先）の予測期間を設定し，30分間隔で最適化を実行した．これにより，年間17,520回の最適化を実行し，各時刻で48時間先までの予測情報を活用した最適な運用計画を実現した．

\subsection{定式化}

\subsubsection{決定変数}

最適化において決定すべき変数（決定変数）を以下に示す：

\textbf{連続変数：}
\begin{itemize}
    \item $s^{\mathrm{BY}}_{k}$:買電量 [kW]
    \item $s^{\mathrm{SL}}_{k}$:売電量 [kW]
    \item $s^{\mathrm{BY}}_{\mathrm{MAX}}$:契約電力(予測期間内の最大買電量)[kW]
    \item $b^{\mathrm{F}}_{k}$:蓄電池SOC [kWh]
    \item $x^{\mathrm{FC1}}_{k}$:充電電力（変換前）[kW]
    \item $x^{\mathrm{FC2}}_{k}$:充電電力（変換後）[kW]
    \item $x^{\mathrm{FD1}}_{k}$:放電電力（変換前）[kW]
    \item $x^{\mathrm{FD2}}_{k}$:放電電力（変換後）[kW]
    \item $g^{\mathrm{P1}}_{k}$:PV発電可能量（入力データ）[kW]
    \item $g^{\mathrm{P2}}_{k}$:実際に使用するPV発電量 [kW]
    \item $d^{\mathrm{A1}}_{k}$:需要電力（変換前）[kW]
    \item $d^{\mathrm{A2}}_{k}$:需要電力（変換後，入力データ）[kW]
\end{itemize}

\textbf{二値変数（0または1）：}
\begin{itemize}
    \item $z_{k}$:充放電の選択（1=充電可能，0=放電可能）
\end{itemize}

\subsubsection{目的関数}

予測期間内の電気料金の総和を最小化する．電気料金は基本料金（契約電力に依存）とエネルギー料金（使用電力量に依存）から構成される：

\begin{equation}
\text{Minimize} \quad w_{\mathrm{basic}} \cdot s^{\mathrm{BY}}_{\mathrm{MAX}} + \sum_{k=0}^{H-1} p^{\mathrm{BY}}_{k} \cdot s^{\mathrm{BY}}_{k} \cdot 0.5
\label{eq:objective}
\end{equation}

ここで，
\begin{itemize}
    \item $s^{\mathrm{BY}}_{k}$:時刻$k$における買電量 [kW]
    \item $s^{\mathrm{BY}}_{\mathrm{MAX}}$:予測期間内の最大買電量(契約電力)[kW]
    \item $w_{\mathrm{basic}}$:基本料金係数（後述） [円/kW]
    \item $p^{\mathrm{BY}}_{k}$:時刻$k$における買電電力量価格 [円/kWh]
    \item $0.5$: 30分間隔から時間単位への換算係数[h]
    \item $H$:予測ステップ数(本研究では96ステップ)
\end{itemize}

基本料金係数$w_{\mathrm{basic}}$は，年間の基本料金を予測期間の長さに応じて按分したものであり，以下のように計算される．
\begin{equation}
    w_{\mathrm{basic}} = 2829.60 \times 0.85 \times 12 \times \frac{H \times 0.5}{24 \times 365}
    \label{eq:weight_basic}
\end{equation}
この式は，年間の基本料金単価（2829.60円/kW・月 $\times$ 力率割引0.85 $\times$ 12ヶ月）を、1年間の総時間（$24 \times 365$[h]）で割り，それに予測期間（$H \times 0.5[h] = 48[h]$）を掛けることで，予測期間あたりの基本料金の重みを算出している．これにより，予測期間内のピーク電力 $s^{\mathrm{BY}}_{\mathrm{MAX}}$ が年間契約電力に与える影響を近似的に評価するための係数として機能する．

\noindent
\textbf{基本料金係数の設定根拠}：本研究では，市場価格連動プランにおいても基本料金は北海道電力と同じと仮定する（本研究の前提条件）．したがって，$w_{\mathrm{basic}}$の値は北海道電力の実際の料金体系（2,829.60円/kW・月）に基づいており，両プランで同一の係数を使用している．

最適化の予測期間が1年未満であるため，この係数はあくまで将来のピーク電力を抑制するための近似的な指標である．年間の基本料金は，シミュレーション完了後に，実際に記録された年間最大需要電力に基づいて別途計算される．

\noindent
\textbf{按分手法の数理的限界}：本来，契約電力（基本料金の決定要因）は「年間17,520ステップの中の最大値」という\textbf{大域的な指標}で決まる．一方，本手法では各予測期間（48時間，96ステップ）内の最大値$s^{\mathrm{BY}}_{\mathrm{MAX}}$に按分係数を乗じてペナルティを与えており，これは「局所的な最大値の抑制」を通じて「大域的な最大値」を間接的に制御する近似である．

この近似には以下の限界がある：
\begin{itemize}
    \item ある予測期間でピークを抑制しても，別の期間で大きなピークが発生すれば，その抑制努力は年間契約電力に反映されない
    \item 逆に，ある予測期間でピークを許容しても，それが年間最大値とならなければ基本料金には影響しない
    \item 按分係数$w_{\mathrm{basic}}$の値によって，ソルバーの「ピーク抑制」と「電力量料金削減」のトレードオフ判断が変化する可能性がある
\end{itemize}

\noindent
特に市場価格連動プランでは，価格が安い時間帯に買電を集中させるインセンティブがあるため，この近似の影響が顕在化しやすい．本手法の限界と結果への影響については，考察（\ref{sec:wbasic_limitation}節）で詳細に分析する．

\subsubsection{制約条件}

\textbf{(1) 電力収支制約}
\begin{equation}
g^{\mathrm{P2}}_{k} + s^{\mathrm{BY}}_{k} - s^{\mathrm{SL}}_{k} - x^{\mathrm{FC1}}_{k} + x^{\mathrm{FD2}}_{k} - d^{\mathrm{A1}}_{k} = 0, \quad \forall k \in \{0,1,2,\dots,H-1\}
\end{equation}

\textbf{(2) PV利用可能制約}
\begin{equation}
g^{\mathrm{P2}}_{k} \leq g^{\mathrm{P1}}_{k}, \quad \forall k \in \{0,1,2,\dots,H-1\}
\end{equation}

ここで，$g^{\mathrm{P1}}_{k}$は気象データから得られるPV発電可能量[kW]，$g^{\mathrm{P2}}_{k}$は実際に使用するPV発電量[kW]である．不等式制約とすることで，必要に応じてPV発電を使用しない柔軟性を持たせている．

\textbf{(3) 需要変換効率}
\begin{equation}
d^{\mathrm{A2}}_{k} = \alpha_{\mathrm{DA}} \cdot d^{\mathrm{A1}}_{k}, \quad \forall k \in \{0,1,2,\dots,H-1\}
\end{equation}

ここで，$\alpha_{\mathrm{DA}} = 0.98$である．

\textbf{(4) 充電プロセス}
\begin{equation}
x^{\mathrm{FC2}}_{k} = \alpha_{\mathrm{FC}} \cdot x^{\mathrm{FC1}}_{k}, \quad \forall k \in \{0,1,2,\dots,H-1\}
\end{equation}

\textbf{(5) 放電プロセス}
\begin{equation}
x^{\mathrm{FD2}}_{k} = \alpha_{\mathrm{FD}} \cdot x^{\mathrm{FD1}}_{k}, \quad \forall k \in \{0,1,2,\dots,H-1\}
\end{equation}

ここで，$\alpha_{\mathrm{FC}} = \alpha_{\mathrm{FD}} = 0.98$（仮定値）である．

\textbf{(6) SOC更新式}

初期SOCは以下で与えられる：
\begin{equation}
b^{\mathrm{F}}_{0} = b_{\mathrm{F}}^{\mathrm{init}} + x^{\mathrm{FC2}}_{0} \cdot 0.5 - x^{\mathrm{FD1}}_{0} \cdot 0.5
\end{equation}

ここで，$b_{\mathrm{F}}^{\mathrm{init}}$は最適化開始時（第0ステップの充放電前）のSOC初期値[kWh]である．

$k \geq 1$のステップでは，以下の更新式に従う：
\begin{equation}
b^{\mathrm{F}}_{k} = b^{\mathrm{F}}_{k-1} + x^{\mathrm{FC2}}_{k} \cdot 0.5 - x^{\mathrm{FD1}}_{k} \cdot 0.5, \quad \forall k \in \{1,2,\dots,H-1\}
\end{equation}

ここで，係数$0.5$は時間間隔0.5時間（30分）を表す．充放電電力[kW]に時間[h]を乗じることで，エネルギー変化量[kWh]が得られる．自己放電は無視する．

\textbf{(7) SOC範囲制約}
\begin{equation}
0.05\times b^{\max}_{\mathrm{F}} \leq b^{\mathrm{F}}_{k} \leq 0.95\times b^{\max}_{\mathrm{F}}, \quad \forall k \in \{0,1,2,\dots,H-1\}
\end{equation}

蓄電池全容量を $b^{\max}_{\mathrm{F}}=860\ \mathrm{kWh}$ としているため，上式は数値的に
\begin{equation*}
    43\ \mathrm{kWh} \leq b^{\mathrm{F}}_{k} \leq 817\ \mathrm{kWh}
\end{equation*}
と表現できる．

\textbf{(8) 充放電電力制約}

充放電電力の上限制約を以下のように設定する：
\begin{align}
0 &\leq x^{\mathrm{FC2}}_{k} \leq 400, \quad \forall k \in \{0,1,2,\dots,H-1\} \\
0 &\leq x^{\mathrm{FD1}}_{k} \leq 400, \quad \forall k \in \{0,1,2,\dots,H-1\}
\end{align}

ここで，400kWは蓄電池の最大充放電出力である．変換前の充電電力$x^{\mathrm{FC1}}_{k}$と変換後の放電電力$x^{\mathrm{FD2}}_{k}$は，変換効率の制約(4)(5)により間接的に制限される．

\textbf{(9) 非同時充放電制約}

同一時刻に充電と放電を同時に行わないことを保証するため，二値変数$z_{k} \in \{0, 1\}$を導入し，以下の制約を設ける：
\begin{align}
x^{\mathrm{FC1}}_{k} &\leq M \cdot z_{k}, \quad \forall k \in \{0,1,2,\dots,H-1\} \\
x^{\mathrm{FD1}}_{k} &\leq M \cdot (1 - z_{k}), \quad \forall k \in \{0,1,2,\dots,H-1\}
\end{align}

ここで，$M$は十分大きな定数（本実装では$M = 10^6$）である．$z_{k} = 1$のときは充電のみ可能，$z_{k} = 0$のときは放電のみ可能となる．

\textbf{(10) 売電禁止制約}

売電を禁止するため，売電量を0とする：
\begin{equation}
s^{\mathrm{SL}}_{k} = 0, \quad \forall k \in \{0,1,2,\dots,H-1\}
\end{equation}

\textbf{(11) 契約電力制約}
\begin{equation}
s^{\mathrm{BY}}_{k} \leq s^{\mathrm{BY}}_{\mathrm{MAX}}, \quad \forall k \in \{0,1,2,\dots,H-1\}
\end{equation}

この制約により，予測期間内の全ての買電量が契約電力$s^{\mathrm{BY}}_{\mathrm{MAX}}$以下となることを保証する．さらに，目的関数において$s^{\mathrm{BY}}_{\mathrm{MAX}}$に基本料金係数$w_{\mathrm{basic}}$が乗じられているため，最適化では$s^{\mathrm{BY}}_{\mathrm{MAX}}$を最小化しようとする．その結果，$s^{\mathrm{BY}}_{\mathrm{MAX}} = \max_{k \in \{0,1,\dots,H-1\}} s^{\mathrm{BY}}_{k}$（予測期間内の最大買電量）が自動的に成立する．

\subsection{料金体系}

\subsubsection{北海道電力基本プラン（高圧電力，一般料金）}

表\ref{tab:hokkaido_tariff}に北海道電力の料金体系を示す．

\begin{table}[H]
\centering
\caption{北海道電力の料金体系（2024年4月1日実施）}
\label{tab:hokkaido_tariff}
\begin{tabular}{lc}
\toprule
項目 & 料金単価 \\
\midrule
基本料金 & 2,829.60 円/kW \\
電力量料金 & 21.51 円/kWh \\
再エネ賦課金 & 3.98 円/kWh \\
\bottomrule
\end{tabular}
\end{table}

\textbf{基本料金の計算式:}
\begin{equation}
C_{\mathrm{basic}} = P_{\mathrm{contract}} \times 2829.60 \times 0.85 \times 12 \quad \text{[円/年]}
\end{equation}

ここで，$P_{\mathrm{contract}}$は契約電力であり，過去1年間の各月の最大需要電力のうち，最も大きい値を適用する．本シミュレーションでは，1年間の運用結果から得られた最大買電電力を$P_{\mathrm{contract}}$として事後的に計算している．

\textbf{電力量料金の計算式:}
\begin{equation}
C_{\mathrm{energy}} = E_{\mathrm{month}} \times (21.51 + F_{\mathrm{adj}}(m) + 3.98) \quad \text{[円/月]}
\end{equation}

ここで，$E_{\mathrm{month}}$は月間電力使用量 [kWh]，$F_{\mathrm{adj}}(m)$は$m$月（$m \in \{1,2,\dots,12\}$）の燃料費調整額 [円/kWh]である．

表\ref{tab:fuel_adjustment}に2024年の月別燃料費調整額を示す．

\begin{table}[H]
\centering
\caption{2024年の月別燃料費調整額（北海道電力・高圧）}
\label{tab:fuel_adjustment}
\begin{tabular}{cc}
\toprule
月 & 燃料費調整額 [円/kWh] \\
\midrule
1月 & $-8.76$ \\
2月 & $-8.59$ \\
3月 & $-8.56$ \\
4月 & $-8.85$ \\
5月 & $-9.02$ \\
6月 & $-7.47$ \\
7月 & $-5.69$ \\
8月 & $-5.69$ \\
9月 & $-9.60$ \\
10月 & $-9.47$ \\
11月 & $-8.06$ \\
12月 & $-5.83$ \\
\bottomrule
\end{tabular}
\end{table}

\subsubsection{市場価格連動プラン}

市場価格連動プランでは，電力量料金がJEPX（日本卸電力取引所）のスポット価格に連動する．

\textbf{電力量料金の計算式:}
\begin{equation}
C_{\mathrm{energy}} = E_{\mathrm{month}} \times (P_{\mathrm{JEPX}}(t) + 3.98) \quad \text{[円/月]}
\end{equation}

ここで，$P_{\mathrm{JEPX}}(t)$は時刻 $t$ のJEPXスポット価格 [円/kWh]である．基本料金は北海道電力と同額とする．

\section{実験設定}

\subsection{データ}

\begin{itemize}
    \item \textbf{期間}：2024年1月1日 ～ 12月31日(2月29日を除く365日)
    \item \textbf{時間間隔}：30分
    \item \textbf{消費電力データ}：20250901サンプルデータ.xlsx(「30分値」シートから取得,単位はkWh/30分)
    \item \textbf{PV発電データ}：20250901サンプルデータ.xlsx(「30分値」シートから取得,単位はkWh/30分)
    \item \textbf{JEPX価格データ}：一般社団法人日本卸電力取引所公開データ(2024年1月～12月のスポット価格,単位は円/kWh)(https://www.jepx.jp/electricpower/market-data/spot/より取得)
    \item \textbf{注記}：2024年は閏年であるが,使用データは2月29日を含まない365日分である
\end{itemize}

\subsubsection{データ前処理}

Excelファイルから読み込んだデータは，最適化計算の前に以下の単位変換を実施する：

\begin{itemize}
    \item \textbf{入力データ}：30分積算電力量 [kWh/30分]
    \item \textbf{変換後データ}：平均電力 [kW]
    \item \textbf{変換式}：$P_{\mathrm{avg}}[\mathrm{kW}] = E_{30\mathrm{min}}[\mathrm{kWh}] \div 0.5[\mathrm{h}]$
\end{itemize}

この変換により，30分間の電力量から1時間あたりの平均電力値が得られる．最適化では全て電力[kW]を基準とし，目的関数において電力量[kWh]への換算（$\times 0.5$時間）を行う．

\subsection{計算環境}

\begin{itemize}
    \item \textbf{プログラミング言語}：Python 3.x
    \item \textbf{最適化ソルバー}：PySCIPOpt
    \item \textbf{データ処理}：pandas, numpy
    \item \textbf{可視化}：matplotlib
\end{itemize}

\subsection{最適化パラメータ}

\begin{itemize}
    \item \textbf{予測期間}：$H = 96$ ステップ（48時間先まで予測）
    \item \textbf{制御周期}：1ステップ（30分ごとに最適化を実行）
\end{itemize}

\section{結果}

本研究では，2つのシナリオについて検証を行った：シナリオA（蓄電池容量と料金プラン選択），シナリオB（予測期間の影響比較）．以下に各シナリオの結果を示す．

\subsection{シナリオA：蓄電池容量と料金プラン選択}

予測期間$H=96$（48時間）の条件下で，蓄電池容量を0kWh（蓄電池なし）から1720kWhまで変化させ，北海道電力基本プランと市場価格連動プランの経済性を比較した．

\subsubsection{蓄電池容量別の料金プラン比較}

表\ref{tab:capacity_plan_comparison}に蓄電池容量別の両プラン年間コスト比較を示す．

\begin{table}[H]
\centering
\caption{蓄電池容量別の年間コスト比較（両プラン）}
\label{tab:capacity_plan_comparison}
\begin{tabular}{rrrrl}
\toprule
容量 [kWh] & 北電基本 [円] & 市場連動 [円] & 差額 [円] & 有利なプラン \\
\midrule
0 & 18,516,214 & 17,829,792 & $-686,422$ & 市場連動 \\
215 & 15,984,316 & 15,177,856 & $-806,460$ & 市場連動 \\
430 & 15,354,276 & 15,007,684 & $-346,592$ & 市場連動 \\
540 & 15,148,351 & 15,226,725 & $+78,374$ & \textbf{北電基本} \\
645 & 14,980,427 & 15,256,184 & $+275,757$ & \textbf{北電基本} \\
860 & 14,757,247 & 15,396,972 & $+639,725$ & \textbf{北電基本} \\
1290 & 14,478,318 & 15,549,018 & $+1,070,700$ & \textbf{北電基本} \\
1720 & 14,476,495 & 15,715,245 & $+1,238,750$ & \textbf{北電基本} \\
\bottomrule
\end{tabular}
\end{table}

\noindent
差額は「北電基本 $-$ 市場連動」を示す．正の値は北電基本プランが安価，負の値は市場連動プランが安価であることを意味する．\textbf{430kWh〜540kWhの間で料金プランの有利性が逆転}することが確認できる．

\subsubsection{各プラン最適容量での公平な比較}

各料金プランにとって最適な蓄電池容量での比較を表\ref{tab:optimal_comparison}に示す．

\begin{table}[H]
\centering
\caption{各プラン最適容量での年間コスト比較}
\label{tab:optimal_comparison}
\begin{tabular}{llrr}
\toprule
料金プラン & 最適容量 & 年間コスト [円] & 契約電力 [kW] \\
\midrule
市場価格連動プラン & 430 kWh & 15,007,684 & 205.73 \\
北海道電力基本プラン & 1720 kWh & 14,476,495 & 161.16 \\
\midrule
\multicolumn{2}{l}{\textbf{差額}} & \multicolumn{2}{l}{\textbf{531,189円（北電基本が安価）}} \\
\bottomrule
\end{tabular}
\end{table}

\noindent
それぞれのプランにとって最適な蓄電池容量で比較した場合でも，\textbf{北海道電力基本プラン＋1720kWhが市場価格連動プラン＋430kWhより約53万円安価}である．これにより，蓄電池容量の選択に関わらず，北海道電力基本プランが経済的に有利であることが確認された．

\subsubsection{料金プランの特性と最適容量の違い}

表\ref{tab:capacity_comparison_detail}に両プランの蓄電池容量別詳細比較を示す．

\begin{table}[H]
\centering
\caption{蓄電池容量別の詳細比較（北海道電力基本プラン）}
\label{tab:capacity_comparison_detail}
\begin{tabular}{rrrrrr}
\toprule
容量 [kWh] & 契約電力 [kW] & 買電量 [kWh] & PV利用率 [\%] & 年間コスト [円] & コスト差 [円] \\
\midrule
0 & 267.35 & 605,181 & 78.01 & 18,516,214 & - \\
215 & 202.38 & 566,953 & 92.43 & 15,984,316 & $-2,531,898$ \\
430 & 189.84 & 551,201 & 98.41 & 15,354,276 & $-3,161,938$ \\
540 & 184.10 & 548,803 & 99.46 & 15,148,351 & $-3,367,863$ \\
645 & 178.70 & 548,077 & 99.86 & 14,980,427 & $-3,535,787$ \\
860 & 170.93 & 548,136 & 100.0 & 14,757,247 & $-3,758,967$ \\
1290 & 161.16 & 548,291 & 100.0 & 14,478,318 & $-4,037,896$ \\
1720 & 161.16 & 548,175 & 100.0 & 14,476,495 & $-4,039,719$ \\
\bottomrule
\end{tabular}
\end{table}

\begin{table}[H]
\centering
\caption{蓄電池容量別の詳細比較（市場価格連動プラン）}
\label{tab:capacity_comparison_market_detail}
\begin{tabular}{rrrrrr}
\toprule
容量 [kWh] & 契約電力 [kW] & 買電量 [kWh] & PV利用率 [\%] & 年間コスト [円] & コスト差 [円] \\
\midrule
0 & 267.35 & 605,181 & 78.01 & 17,829,792 & - \\
215 & 202.54 & 567,875 & 92.43 & 15,177,856 & $-2,651,936$ \\
430 & 205.73 & 551,802 & 98.41 & 15,007,684 & $-2,822,108$ \\
540 & 214.75 & 549,176 & 99.46 & 15,226,725 & $-2,603,067$ \\
645 & 216.37 & 548,243 & 99.86 & 15,256,184 & $-2,573,608$ \\
860 & 221.56 & 547,990 & 100.0 & 15,396,972 & $-2,432,820$ \\
1290 & 226.95 & 547,976 & 100.0 & 15,549,018 & $-2,280,774$ \\
1720 & 232.94 & 547,815 & 100.0 & 15,715,245 & $-2,114,547$ \\
\bottomrule
\end{tabular}
\end{table}

\noindent
コスト差は0kWh（蓄電池なし）を基準とした差額を示す．両プランで以下の特性の違いが観察された：

\begin{itemize}
    \item \textbf{北海道電力基本プラン}：蓄電池容量の増加に伴い契約電力が一貫して減少（267.35kW → 161.16kW）．容量増加による経済効果が継続し，1720kWhで最小コストを達成．
    \item \textbf{市場価格連動プラン}：430kWhまでは契約電力が減少するが，それ以降は容量増加に伴い契約電力が増加（205.73kW → 232.94kW）．430kWhで最小コストを達成し，それ以上の容量は逆効果．
\end{itemize}

\subsubsection{代表的な条件での詳細比較（蓄電池860kWh）}

以下では，蓄電池容量860kWhの条件下での両プランの詳細な比較結果を示す．

表\ref{tab:annual_cost}に両プランの年間電気料金の内訳を示す．

\begin{table}[H]
\centering
\caption{年間電気料金の比較（蓄電池860kWh，2024年実績）}
\label{tab:annual_cost}
\begin{tabular}{lrr}
\toprule
項目 & 北海道電力基本プラン & 市場価格連動プラン \\
\midrule
基本料金 [円] & 4,933,365 & 6,394,573 \\
電力量料金 [円] & 11,790,414 & 6,821,397 \\
燃料費調整額 [円] & $-4,148,116$ & - \\
再エネ賦課金 [円] & 2,181,583 & 2,181,002 \\
\midrule
\textbf{年間合計 [円]} & \textbf{14,757,247} & \textbf{15,396,972} \\
\midrule
契約電力 [kW] & 170.93 & 221.56 \\
年間削減額 [円] & \multicolumn{2}{c}{639,725（北海道電力基本プランが安価）} \\
\bottomrule
\end{tabular}
\end{table}

\noindent
\textbf{計算条件：}
\begin{itemize}
    \item 北海道電力基本プラン：電力量料金21.51円/kWh + 月別燃料費調整額（-5.83〜-9.60円/kWh）+ 再エネ賦課金3.98円/kWh
    \item 市場価格連動プラン：JEPX価格 + 再エネ賦課金3.98円/kWh
    \item 基本料金単価：2,829.60円/kW × 0.85（力率割引）× 12ヶ月
\end{itemize}

\subsubsection{システム運用統計（蓄電池860kWh）}

表\ref{tab:system_stats}に2024年の年間システム運用統計を示す．両プランで料金体系が異なるため，最適な運用パターンも異なる結果となった．

\begin{table}[H]
\centering
\caption{年間システム運用統計（2024年）}
\label{tab:system_stats}
\begin{tabular}{lrr}
\toprule
項目 & 北海道電力基本プラン & 市場価格連動プラン \\
\midrule
総需要電力量 [kWh] & \multicolumn{2}{c}{812,982} \\
総PV発電量 [kWh] & \multicolumn{2}{c}{287,633} \\
\quad PV自家消費量 [kWh] & 287,633 & 287,633 \\
\quad PV余剰量 [kWh] & 0 & 0 \\
総買電量 [kWh] & 548,136 & 547,990 \\
\midrule
PV自給率 [\%] & 35.4 & 35.4 \\
PV利用率 [\%] & 100.00 & 100.00 \\
最大買電電力 [kW] & 170.93 & 221.56 \\
平均買電電力 [kW] & 62.57 & 62.56 \\
平均SOC [kWh] & 384.27 (44.7\%) & 357.76 (41.6\%) \\
満充電回数 & 155 & 125 \\
\bottomrule
\end{tabular}
\end{table}

\noindent
総需要電力量812,982kWhに対し，両プランともPV発電量287,633kWhの100\%が自家消費され，PV自給率35.4\%を達成した．市場価格連動プランでは，電力価格が安い時間帯に集中的に買電を行う傾向があり，これにより最大買電電力が221.56kWと高くなった．一方，北海道電力基本プランでは価格が一定であるため，買電電力を平準化し契約電力を170.93kWに抑制している．

\subsubsection{年間のPV発電と買電の関係}

年間のPV発電量・買電量・需要の推移を図\ref{fig:pv_buysell}に示す．

\begin{figure}[H]
\centering
\includegraphics[width=\textwidth]{../png/soc860/annual_pv_buy_demand.png}
\caption{年間のPV発電・買電・需要の推移}
\label{fig:pv_buysell}
\end{figure}

\subsubsection{年間の蓄電池SOC推移}

年間の蓄電池SOC（State of Charge）の推移を図\ref{fig:annual_soc}に示す．SOCは1日の中で充放電を繰り返しながら変動していることがわかる．北海道電力基本プランでは年間平均SOC 384.27kWh（44.7\%），市場価格連動プランでは357.76kWh（41.6\%）である．

\begin{figure}[H]
\centering
\includegraphics[width=\textwidth]{../png/soc860/annual_soc.png}
\caption{年間の蓄電池SOC推移（2024年）}
\label{fig:annual_soc}
\end{figure}

\subsubsection{蓄電池の運用パターン}

代表的な1日の運用パターンを，需要レベルが異なる2つのケースについて分析する．図\ref{fig:battery_operation}に需要が高い日（約2,450 kWh）の比較を示す．需要がほぼ同等でPV発電量が大きく異なる2日を選定し，PV発電量の違いが蓄電池運用に与える影響を明確にする．各グラフは左軸に電力フロー（需要，PV発電，買電）を，右軸に蓄電池SOCの時間変化を示している．

\subsubsection{需要が高い日の比較（約2,450 kWh）}

図\ref{fig:battery_operation}に，需要が高い日の運用パターンを示す．PV発電量が多い日（2024年6月2日，1,433 kWh）とPV発電量が少ない日（2024年6月24日，237 kWh）を比較する．

\textbf{PV発電量が多い日（6月2日）：}
\begin{itemize}
    \item \textbf{総需要}：2,436 kWh，\textbf{PV発電}：1,433 kWh，\textbf{買電}：1,275 kWh
    \item \textbf{昼間（6:00〜18:00）}：PV発電が豊富で需要を大きく上回る時間帯があり，余剰電力を蓄電池に充電．SOCが最大694 kWhまで上昇
    \item \textbf{夜間（18:00〜6:00）}：PV発電がゼロとなり，蓄電池から放電して需要を賄う．買電と蓄電池放電を組み合わせた運用
\end{itemize}

\textbf{PV発電量が少ない日（6月24日）：}
\begin{itemize}
    \item \textbf{総需要}：2,461 kWh，\textbf{PV発電}：237 kWh，\textbf{買電}：2,076 kWh
    \item \textbf{昼間（6:00〜18:00）}：PV発電が少なく，需要の大部分を買電で賄う．蓄電池への充電は限定的でSOCは最大206 kWhに留まる
    \item \textbf{夜間（18:00〜6:00）}：PV発電がゼロとなり，買電が主体．蓄電池は補助的に使用される
\end{itemize}

需要が高い場合，PV発電が豊富な日は買電を1,275 kWhに抑制できる一方，PV発電が少ない日は2,076 kWhの買電が必要となり，約1.6倍の差が生じる．

\begin{figure}[H]
\centering
\includegraphics[width=\textwidth]{../png/soc860/daily_battery_pattern.png}
\caption{需要が高い日の運用パターン（需要約2,450 kWh）．上：PV発電量が多い日（2024年6月2日，PV発電1,433 kWh），下：PV発電量が少ない日（2024年6月24日，PV発電237 kWh）．左軸：電力フロー（需要，PV発電，買電），右軸：蓄電池SOCの時間変化．}
\label{fig:battery_operation}
\end{figure}

\subsubsection{需要が低い日の比較（約1,290 kWh）}

図\ref{fig:battery_operation_low}に，需要が低い日の運用パターンを示す．PV発電量が多い日（2024年2月5日，1,019 kWh）とPV発電量が少ない日（2024年1月22日，281 kWh）を比較する．

\textbf{PV発電量が多い日（2月5日）：}
\begin{itemize}
    \item \textbf{総需要}：1,284 kWh，\textbf{PV発電}：1,019 kWh，\textbf{買電}：270 kWh
    \item \textbf{昼間（6:00〜18:00）}：PV発電が需要を大きく上回り，余剰電力を蓄電池に充電．SOCが最大609 kWhまで上昇
    \item \textbf{夜間（18:00〜6:00）}：蓄電池から放電して需要の大部分を賄い，買電を最小限に抑制
\end{itemize}

\textbf{PV発電量が少ない日（1月22日）：}
\begin{itemize}
    \item \textbf{総需要}：1,298 kWh，\textbf{PV発電}：281 kWh，\textbf{買電}：862 kWh
    \item \textbf{昼間（6:00〜18:00）}：PV発電が少なく，需要の大部分を買電で賄う．蓄電池への充電は限定的でSOCは最大468 kWhに留まる
    \item \textbf{夜間（18:00〜6:00）}：買電が主体となり，蓄電池は補助的に使用される
\end{itemize}

需要が低い場合，PV発電が豊富な日は買電を270 kWhに大幅に抑制できる一方，PV発電が少ない日は862 kWhの買電が必要となり，約3.2倍の差が生じる．需要が低い場合の方が，PV発電量の違いによる買電量の差がより顕著に現れることが確認できる．

\begin{figure}[H]
\centering
\includegraphics[width=\textwidth]{../png/soc860/daily_battery_pattern_low_demand.png}
\caption{需要が低い日の運用パターン（需要約1,290 kWh）．上：PV発電量が多い日（2024年2月5日，PV発電1,019 kWh），下：PV発電量が少ない日（2024年1月22日，PV発電281 kWh）．左軸：電力フロー（需要，PV発電，買電），右軸：蓄電池SOCの時間変化．}
\label{fig:battery_operation_low}
\end{figure}

\subsubsection{需要レベルによる運用特性の違い}

需要が高い日と低い日の比較から，以下のような運用特性の違いが明らかになった：

\begin{itemize}
    \item \textbf{買電量の削減率}：需要が低い場合(3.2倍の差)の方が，需要が高い場合(1.6倍の差)よりもPV発電量の違いによる買電量の差が顕著
    \item \textbf{蓄電池の活用度}：需要が低い場合，PV発電が豊富な日は蓄電池を効果的に活用して夜間需要を賄うことができる
    \item \textbf{PV自給率}：需要が低い場合，PV発電が豊富な日は買電を大幅に削減でき(買電比率21.0\%)，高い自給率を実現できる
\end{itemize}

\subsubsection{買電電力が一定値となることの理由}

図\ref{fig:battery_operation}において，買電電力がある程度一定の値を保つことが観察される．これは，本最適化問題におけるデマンド料金制度と契約電力制約の影響によるものである．

本最適化では，目的関数は基本料金と電力量料金の合計として定式化される：
\begin{equation}
\text{総コスト} = \text{基本料金} \times \text{sBYMAX} + \sum_{k} \text{電力量単価}_k \times \text{sBY}_k \times 0.5
\end{equation}

ここで，$\text{sBYMAX}$は契約電力（予測期間内の最大買電電力），$\text{sBY}_k$は時刻$k$における買電電力である．制約条件として，各時刻の買電電力は契約電力以下でなければならない：
\begin{equation}
\text{sBY}_k \leq \text{sBYMAX}, \quad \forall k
\end{equation}

このとき，最適化は以下のように動作する：

\begin{enumerate}
    \item \textbf{契約電力の決定}：予測期間内で必要な最大買電電力に基づいて$\text{sBYMAX}$が決定される
    \item \textbf{基本料金の固定化}：一度$\text{sBYMAX}$が決まると，その期間内の基本料金は固定される
    \item \textbf{買電電力の平準化}：契約電力の枠内で買電できる余地がある場合，需要変動は蓄電池の充放電で吸収し，買電電力を一定に保つことが合理的となる
    \item \textbf{蓄電池との協調}：買電電力を一定に保つことで，契約電力を最小限に抑えつつ，需要変動は蓄電池で吸収する運用が実現される
\end{enumerate}

例えば，6月2日のデータでは，買電電力は夜間で約57 kW，PV発電開始後は約52 kWの2段階の一定値を示す．これにより，需要変動（54〜146 kW）に対して，PV発電と蓄電池の充放電を組み合わせることで，契約電力を最小化しつつ需要を満たす運用が達成されている．

\subsection{シナリオB：予測期間（ホライズン）の影響比較}

市場価格連動プラン，蓄電池容量860kWhの条件下で，予測期間$H$を変化させて比較した．短期予測（$H=48$，24時間先），中期予測（$H=96$，48時間先），長期予測（$H=144$，72時間先）の3ケースを検証した．

\subsubsection{予測期間の比較結果}

表\ref{tab:horizon_comparison}に24時間・48時間・72時間予測の比較結果を示す．

\begin{table}[H]
\centering
\caption{予測期間による年間統計の比較（市場価格連動プラン，蓄電池860kWh）}
\label{tab:horizon_comparison}
\begin{tabular}{lrrr}
\toprule
項目 & 24時間予測 & 48時間予測 & 72時間予測 \\
\midrule
PV利用率 [\%] & 100.00 & 100.00 & 100.00 \\
PV余剰量 [kWh] & 0 & 0 & 0 \\
契約電力 [kW] & 237.00 & 221.56 & 216.98 \\
年間買電量 [kWh] & 547,810 & 547,990 & 548,014 \\
年間コスト [円] & 15,872,724 & 15,396,972 & 15,227,416 \\
24時間比コスト差 [円] & - & $-475,752$ & $-645,308$ \\
\bottomrule
\end{tabular}
\end{table}

\subsubsection{計算時間の比較}

表\ref{tab:horizon_timing}に予測期間ごとの計算時間を示す．計算環境はMacBook Pro（Apple M1 Pro, 16GB RAM）である．

\begin{table}[H]
\centering
\caption{予測期間ごとの計算時間（蓄電池860kWh，1ステップあたり制限時間10秒）}
\label{tab:horizon_timing}
\begin{tabular}{lrrr}
\toprule
予測期間 & 北海道電力プラン [分] & 市場連動プラン [分] & 合計 [分] \\
\midrule
$H=48$（24時間） & 6.3 & 6.4 & 12.8 \\
$H=96$（48時間） & 18.1 & 17.0 & 35.1 \\
$H=144$（72時間） & 30.7 & 28.1 & 58.9 \\
\bottomrule
\end{tabular}
\end{table}

\subsubsection{予測期間の影響に関する知見}

\begin{enumerate}
    \item \textbf{PV利用率}：24時間・48時間・72時間予測すべてで100.00\%を達成し，PV余剰は発生しなかった．

    \item \textbf{契約電力削減効果}：予測期間の延長に伴い契約電力が減少した．24時間予測（237.00kW）→ 48時間予測（221.56kW，$-$15.44kW）→ 72時間予測（216.98kW，$-$20.02kW）．ただし，48時間→72時間の改善幅（4.58kW）は24時間→48時間の改善幅（15.44kW）より小さく，効果が逓減している．

    \item \textbf{年間コスト削減効果}：24時間予測を基準とすると，48時間予測で約47.6万円（3.0\%），72時間予測で約64.5万円（4.1\%）のコスト削減を達成した．48時間→72時間の追加削減は約16.9万円であり，改善効果は逓減傾向にある．

    \item \textbf{計算時間の増加}：予測期間の延長に伴い計算時間がほぼ線形に増加する．24時間予測（12.8分）→ 48時間予測（35.1分，約2.7倍）→ 72時間予測（58.9分，約4.6倍）．年間17,520ステップの最適化を実行するため，予測期間の延長は計算コストに直結する．

    \item \textbf{費用対効果}：48時間予測は24時間予測と比較して計算時間が約2.7倍増加するが，年間コストを約47.6万円削減できる．一方，72時間予測は48時間予測と比較して計算時間が約1.7倍増加するが，追加削減額は約16.9万円に留まる．計算時間と削減効果のバランスから，48時間予測が実用的な選択である．
\end{enumerate}

\section{考察}

\subsection{予測期間の影響分析（24時間から48時間への拡張）}

本研究では，当初24時間先（48ステップ）の予測期間でローリング計画法を実施していたが，PV発電が豊富な日において，蓄電池SOCが満充電に到達しないという現象が観察された．

ここで，\textbf{PV余剰}とは，PV発電量のうち，需要に使用されず，蓄電池にも充電されず，系統への逆潮流もできない（逆潮流不可設定のため）ために，やむを得ず捨てられるエネルギーを指す．PV余剰の発生量は蓄電池容量に大きく依存し，シナリオAの結果（表\ref{tab:capacity_comparison_detail}）から以下のことが確認された：

\begin{itemize}
    \item \textbf{蓄電池なし（0kWh）}：PV利用率78.01\%，年間約63,000kWhのPV余剰が発生
    \item \textbf{蓄電池215kWh}：PV利用率92.43\%，余剰が大幅に減少
    \item \textbf{蓄電池430kWh}：PV利用率98.41\%
    \item \textbf{蓄電池860kWh以上}：PV利用率100\%，余剰ゼロを達成
\end{itemize}

ここで，PV利用率100\%達成の要因を数理的に分解して説明する．本システムでは，年間総需要812,982kWhに対し，年間PV発電可能量は287,633kWhであり，PV自給率（PV発電量/需要）は35.4\%に過ぎない．すなわち，需要がPV発電量の約2.8倍あるため，PV発電の大部分は蓄電池がなくても需要によって自然に消費される構造にある．

蓄電池なしの場合にPV余剰が発生する理由は，PV発電と需要の\textbf{時間パターンの不一致}にある．昼間（6:00〜18:00）の需要は429,104kWh，PV発電は286,157kWhであり，昼間だけを見れば需要がPV発電を上回る．しかし，各時刻で見ると，PV発電が瞬時需要を上回る時間帯が年間の16.0\%（2,797ステップ）存在し，その超過分が約63,000kWhのPV余剰となる．

蓄電池の役割は，この\textbf{時間的ミスマッチの解消}である．蓄電池860kWhを導入することで，昼間のPV超過分（約63,000kWh，PV発電量の22\%相当）を充電し，夜間に放電することが可能となる．これにより，PV利用率が78\%から100\%に向上した．ただし，これは「蓄電池の高度な制御」というより，需要がPV発電量に対して十分に大きいという本システムの構造的特性と，蓄電池による時間シフト機能の組み合わせによる結果である．

以下の考察では，蓄電池860kWhの条件下での予測期間の影響を分析する．

当初，予測期間を24時間（48ステップ）としてローリング計画法を実施したところ，PV発電が豊富な日においても蓄電池が満充電に到達しない現象が観察された．この現象は，ローリング計画法の数理的特性から説明できる．

ローリング計画法では，各時刻において予測期間$H$ステップ先までの目的関数（電気料金）を最小化する．このとき，予測期間外の将来コストは目的関数に含まれないため，ソルバーは予測期間内の情報のみに基づいて意思決定を行う．24時間予測の場合，以下のメカニズムにより充電が抑制される：

\begin{enumerate}
    \item \textbf{将来価値の欠落}：今日充電したエネルギーを明日のピークカットや夜間需要に使用するメリットが，予測期間外であるため目的関数に反映されない．
    \item \textbf{充電コストのみが可視}：充電には効率損失（充電効率0.98 $\times$ 放電効率0.98 $\approx$ 0.96）が伴う．予測期間内で放電機会がなければ，充電は純粋なコスト（効率損失）として認識される．
    \item \textbf{結果としての過小充電}：本来は翌日のピークカットに活用できるエネルギーを，今日充電しないという局所最適な判断が行われる．
\end{enumerate}

予測期間を48時間に延長すると，翌日の需要・価格パターンが目的関数に含まれるため，今日充電して明日放電する価値が評価可能となる．これにより，より長期的に最適な充電判断が実現され，結果として年間コストが削減される．そこで，予測期間を48時間先（96ステップ）および72時間先（144ステップ）に延長し，同一データで最適化を実施した．

表\ref{tab:horizon_comparison_detail}に，蓄電池容量860kWhにおける予測期間$H=48$（24時間），$H=96$（48時間），$H=144$（72時間）の両プランでの比較結果を示す．

\begin{table}[H]
\centering
\caption{予測期間による年間コスト・契約電力の比較（蓄電池860kWh，両プラン）}
\label{tab:horizon_comparison_detail}
\begin{tabular}{llrrrr}
\toprule
予測期間 & 料金プラン & 契約電力 [kW] & 買電量 [kWh] & 年間コスト [円] & 差額 [円] \\
\midrule
\multirow{2}{*}{$H=48$（24時間）} & 北海道電力 & 173.70 & 548,324 & 14,841,141 & - \\
 & 市場連動 & 237.00 & 547,810 & 15,872,724 & - \\
\midrule
\multirow{2}{*}{$H=96$（48時間）} & 北海道電力 & 170.93 & 548,136 & 14,757,247 & $-83,894$ \\
 & 市場連動 & 221.56 & 547,990 & 15,396,972 & $-475,752$ \\
\midrule
\multirow{2}{*}{$H=144$（72時間）} & 北海道電力 & 170.93 & 547,746 & 14,750,294 & $-90,847$ \\
 & 市場連動 & 216.98 & 548,014 & 15,227,416 & $-645,308$ \\
\bottomrule
\end{tabular}
\end{table}

\noindent
予測期間の延長に伴い，両プランとも年間コストが削減された．市場価格連動プランでは，24時間→48時間で約47.6万円（3.0\%），24時間→72時間で約64.5万円（4.1\%）の削減効果があり，契約電力も237.00kW→221.56kW→216.98kWと段階的に低下した．北海道電力基本プランでは，24時間→72時間で約9.1万円（0.6\%）の削減となったが，契約電力は48時間以降170.93kWで収束しており，予測期間延長による追加効果は限定的であった．

\noindent
予測期間の延長効果は逓減傾向にあり，48時間→72時間の追加削減額（市場連動：約16.9万円，北海道電力：約0.7万円）は24時間→48時間の削減額を下回る．表\ref{tab:horizon_efficiency}に，各予測期間延長の費用対効果を示す．

\begin{table}[H]
\centering
\caption{予測期間延長の費用対効果（市場価格連動プラン）}
\label{tab:horizon_efficiency}
\begin{tabular}{lrrr}
\toprule
延長区間 & 追加削減額 [円] & 追加計算時間 [分] & 削減額/時間 [円/分] \\
\midrule
24時間→48時間 & 475,752 & 22.3 & 21,335 \\
48時間→72時間 & 169,556 & 23.8 & 7,124 \\
\bottomrule
\end{tabular}
\end{table}

\noindent
24時間→48時間の延長では，追加計算時間1分あたり約21,300円の削減効果があるのに対し，48時間→72時間では約7,100円/分と約1/3に低下する．

本研究では\textbf{48時間先（96ステップ）の予測期間}を採用した．この選択は以下の判断に基づく：
\begin{itemize}
    \item 24時間予測から48時間予測への延長は，費用対効果が高い（削減額47.6万円，効率21,300円/分）
    \item 48時間から72時間への追加延長は，さらに16.9万円（年間コストの約1.1\%）の削減が可能であるが，費用対効果は約1/3に低下
    \item 本研究の目的は予測期間の最適化ではなく，料金プランと蓄電池容量の比較分析であるため，計算資源の制約から48時間を採用
\end{itemize}

\noindent
\textbf{注}：48時間という選択は，計算時間と削減効果のトレードオフに基づく判断であり，「最適な予測期間」を主張するものではない．72時間予測を採用すれば市場価格連動プランでさらに約16.9万円の削減が可能であり，計算資源が十分であれば72時間以上の予測期間も検討に値する．以降の分析はすべて48時間予測の設定で実施した結果を示している．

\subsubsection{予測期間延長効果の逓減に関する物理的考察}

予測期間延長効果の逓減は，単なる計算時間とのトレードオフではなく，蓄電池の物理的制約に起因するシステム構成上の限界である．表\ref{tab:horizon_soc_analysis}に，予測期間別の蓄電池運用統計を示す．

\begin{table}[H]
\centering
\caption{予測期間別の蓄電池運用統計（北海道電力基本プラン，蓄電池860kWh）}
\label{tab:horizon_soc_analysis}
\begin{tabular}{lrrr}
\toprule
指標 & $H=48$（24時間） & $H=96$（48時間） & $H=144$（72時間） \\
\midrule
年間平均SOC [kWh] & 257.9（30.0\%） & 357.8（41.6\%） & 398.9（46.4\%） \\
年間充電量 [kWh] & 157,788 & 162,353 & 162,941 \\
満充電到達日数 [日/365日] & 9 & 45 & 73 \\
日別SOCレンジ平均 [kWh] & 395.2 & 420.3 & 424.5 \\
\bottomrule
\end{tabular}
\end{table}

\noindent
この結果から，以下の物理的メカニズムが明らかになった：

\begin{enumerate}
    \item \textbf{年間充電量の収束}：24時間→48時間で年間充電量が+4,565kWh（+2.9\%）増加したが，48時間→72時間では+588kWh（+0.4\%）とほぼ収束している．これは，48時間予測で既に「今日充電→明日放電」のサイクルが最適化されており，追加情報の価値が限定的であることを示す．

    \item \textbf{蓄電池容量による制約}：本システムの蓄電池実効容量は731kWh（817kWh$-$86kWh）であり，1日の平均需要2,227kWhの約33\%に相当する．この容量では，2日分以上のエネルギーを蓄えることが物理的に不可能である．したがって，72時間予測で「今日充電→明後日放電」の戦略を立てても，蓄電池容量が2日分のエネルギーシフトを実現するには不十分であり，追加情報の活用が制限される．

    \item \textbf{日別SOCレンジの飽和}：日別SOCレンジ（1日の最大SOC$-$最小SOC）は，24時間→48時間で+25.1kWh増加したが，48時間→72時間では+4.2kWhとほぼ飽和している．これは，蓄電池が1日の中で活用できる容量の上限に近づいていることを示す．

    \item \textbf{需要・PV発電パターンの日周期性}：需要とPV発電は24時間周期のパターンを持つ．48時間予測で翌日のパターンを把握できれば，それ以上の長期予測の価値は逓減する．
\end{enumerate}

\noindent
以上より，予測期間延長効果の逓減は，蓄電池容量が1日の需要に対して約33\%という本システムの構成に起因する構造的限界である．蓄電池容量を大幅に増加させれば，より長期の予測期間が有効となる可能性があるが，本研究の860kWh構成では48時間予測が最適化効果の飽和点に近い．

\subsubsection{料金プランによる予測期間効果の違い}

表\ref{tab:horizon_comparison_detail}において，北海道電力基本プランでは契約電力が48時間予測以降170.93kWで収束しているのに対し，市場価格連動プランでは72時間予測まで契約電力が低下し続けている（237.00kW→221.56kW→216.98kW）．この違いは，両プランの価格構造がソルバーの最適化挙動に与える影響の差異から説明できる．

\noindent
\textbf{北海道電力基本プランにおける予測期間効果が限定的な理由}：

北海道電力基本プランでは電力量料金が一定（21.51円/kWh）であるため，目的関数において「いつ買電するか」は電力量料金の観点からは無差別である．したがって，ソルバーの最適化は主に以下の2点に集中する：
\begin{enumerate}
    \item \textbf{契約電力（ピーク買電電力）の最小化}：基本料金係数$w_{\mathrm{basic}}$により，予測期間内の最大買電電力$s^{\mathrm{BY}}_{\mathrm{MAX}}$を抑制するインセンティブが働く
    \item \textbf{PV余剰の回避}：売電不可の制約下で，PV発電を最大限活用するための充電判断
\end{enumerate}

これらの最適化課題は，本質的に「今日の需要ピークを蓄電池で削る」という\textbf{局所的な判断}で達成可能である．需要パターンは日周期性を持つため，24時間予測で当日のピーク時刻を把握し，48時間予測で翌日の充電機会（PV発電時間帯）を考慮すれば，ピークカット戦略はほぼ最適化される．72時間先の情報は，価格が一定である以上，追加的な意思決定価値をほとんど持たない．

\noindent
\textbf{市場価格連動プランにおける予測期間効果が大きい理由}：

市場価格連動プランではJEPX価格が時間帯により大きく変動する（2024年実績：3.80〜31.00円/kWh）．この価格変動により，ソルバーは以下の追加的な最適化を行う：
\begin{enumerate}
    \item \textbf{価格の安い時間帯への買電集中}：電力量料金を最小化するため，価格が安い時間帯に買電を集中させる
    \item \textbf{価格予測に基づく充放電戦略}：「明日の価格が安いなら今日は買わずに明日まとめ買い」という時間的裁定が有効
\end{enumerate}

この戦略では，長期の価格予測情報が意思決定に直接影響する．48時間予測で翌日の価格パターンを把握でき，72時間予測でさらに翌々日の価格を考慮できる．ただし，蓄電池容量の制約により「明後日の安値を利用」する戦略の実現は困難であるため，72時間予測の追加効果は48時間予測ほど大きくない．

\noindent
\textbf{両プランの比較}：

北海道電力基本プランでは，価格一定性により最適化問題が「ピークカット」という時間的に局所的な課題に帰着する．一方，市場価格連動プランでは，価格変動により最適化問題が「時間的裁定」という長期的な課題を含む．この構造の違いが，予測期間延長効果の差異（北海道電力：約9万円 vs 市場連動：約65万円）を生じさせている．

\subsection{蓄電池容量と料金プラン選択の関係}

蓄電池容量と料金プラン選択の関係について，以下の知見が得られた：

\begin{enumerate}
    \item \textbf{料金プラン有利性の逆転現象}：蓄電池容量430kWh以下では市場価格連動プランが有利，540kWh以上では北海道電力基本プランが有利となる．この逆転点は両プランの契約電力特性の違いに起因する．

    \item \textbf{契約電力特性の違い}：
    \begin{itemize}
        \item \textbf{北海道電力基本プラン}：蓄電池容量増加に伴い契約電力が一貫して減少（0kWh: 267.35kW → 1720kWh: 161.16kW）．価格が一定のため，買電電力の平準化が最適となり，蓄電池はピークカットに活用される．
        \item \textbf{市場価格連動プラン}：430kWhまでは契約電力が減少するが，それ以降は増加に転じる（430kWh: 205.73kW → 1720kWh: 232.94kW）．価格が安い時間帯に集中的に買電・充電するため，大容量蓄電池ほど買電の集中度が高まる．
    \end{itemize}

    \item \textbf{各プランの最適蓄電池容量}：
    \begin{itemize}
        \item 市場価格連動プラン：430kWhで最小コスト（15,007,684円）を達成
        \item 北海道電力基本プラン：1720kWhで最小コスト（14,476,495円）を達成
    \end{itemize}

    \item \textbf{公平な比較による結論}：各プランにとって最適な蓄電池容量で比較した場合でも，北海道電力基本プラン＋1720kWhが市場価格連動プラン＋430kWhより\textbf{約53万円安価}である．したがって，蓄電池容量の選択を含めた総合評価においても，北海道電力基本プランが経済的に有利である．

    \textbf{注}：上記の比較は年間運用コスト（OPEX）のみに基づいており，蓄電池の初期投資コスト（CAPEX）は考慮していない．最適蓄電池容量が430kWhと1720kWhで約4倍異なるため，初期投資額には大きな差が生じる．実際の投資判断においては，蓄電池のkWhあたり単価，耐用年数，割引率等を考慮したライフサイクルコスト分析が必要であるが，これは本研究の範囲外とする．
\end{enumerate}

\subsection{蓄電池の運用戦略}

最適化結果から，以下の蓄電池運用戦略が明らかになった：

\begin{enumerate}
    \item \textbf{昼間充電}：PV発電が豊富な昼間に蓄電池を充電し，余剰電力を有効活用
    \item \textbf{夜間・ピーク時放電}：需要ピーク時に蓄電池から放電し，買電量を削減
    \item \textbf{料金プランによるSOC管理の違い}：
    \begin{itemize}
        \item 北海道電力基本プラン：年間平均SOC 384.27kWh（44.7\%），満充電回数155回
        \item 市場価格連動プラン：年間平均SOC 357.76kWh（41.6\%），満充電回数125回
    \end{itemize}
    北海道電力基本プランの方が蓄電池を積極的に活用し，満充電に到達する頻度が高い．これは，価格一定のため，買電電力の平準化（契約電力の抑制）を優先した運用となっていることを示している．
\end{enumerate}

\subsection{季節別・月別の蓄電池効果分析}

蓄電池860kWhの運用データを季節別・月別に分析し，蓄電池効果の季節変動を明らかにした．表\ref{tab:seasonal_analysis}に季節別統計，表\ref{tab:monthly_analysis}に月別統計を示す．

\begin{table}[H]
\centering
\caption{季節別エネルギー統計と蓄電池効果（蓄電池860kWh，北海道電力基本プラン）}
\label{tab:seasonal_analysis}
\begin{tabular}{lrrrr}
\toprule
季節 & 需要 [MWh] & PV発電 [MWh] & 買電 [MWh] & ピークカット率 [\%] \\
\midrule
春（3--5月） & 170.5 & 86.1 & 89.2 & 33.6 \\
夏（6--8月） & 307.0 & 69.3 & 245.6 & 16.1 \\
秋（9--11月） & 213.3 & 66.4 & 152.8 & 18.8 \\
冬（12--2月） & 122.1 & 65.9 & 60.4 & 64.3 \\
\bottomrule
\end{tabular}
\end{table}

\noindent
ここで，ピークカット率は$(\text{需要ピーク} - \text{買電ピーク}) / \text{需要ピーク} \times 100$で算出した．

\begin{table}[H]
\centering
\caption{月別エネルギー統計と蓄電池効果}
\label{tab:monthly_analysis}
\begin{tabular}{lrrrrrr}
\toprule
月 & 需要 [MWh] & PV [MWh] & 買電 [MWh] & 需要ピーク [kW] & 買電ピーク [kW] & ピークカット率 [\%] \\
\midrule
1月 & 40.2 & 20.9 & 20.6 & 538.8 & 177.2 & 67.1 \\
2月 & 36.7 & 25.3 & 13.1 & 460.8 & 95.4 & 79.3 \\
3月 & 49.0 & 32.4 & 17.8 & 323.3 & 170.9 & 47.2 \\
4月 & 54.9 & 26.6 & 30.1 & 345.5 & 143.5 & 58.5 \\
5月 & 66.6 & 27.1 & 41.3 & 239.0 & 171.1 & 28.4 \\
6月 & 77.6 & 24.8 & 54.9 & 322.9 & 170.3 & 47.3 \\
7月 & 111.2 & 25.6 & 88.5 & 216.7 & 170.9 & 21.1 \\
8月 & 118.2 & 18.8 & 102.2 & 203.4 & 170.7 & 16.1 \\
9月 & 90.9 & 24.9 & 68.6 & 210.2 & 170.7 & 18.8 \\
10月 & 72.5 & 22.0 & 52.3 & 225.8 & 170.3 & 24.5 \\
11月 & 49.9 & 19.5 & 31.9 & 294.6 & 170.1 & 42.3 \\
12月 & 45.3 & 19.8 & 26.7 & 476.1 & 170.1 & 64.3 \\
\midrule
年間 & 812.9 & 287.6 & 548.1 & 538.8 & 177.2 & -- \\
\bottomrule
\end{tabular}
\end{table}

\noindent
季節別・月別分析から，以下の知見が得られた：

\begin{enumerate}
    \item \textbf{冬季（12--2月）の蓄電池効果が最大}：ピークカット率64.3\%（年間最高）を達成した．これは，冬季の需要122.1MWhに対しPV発電65.9MWh（需要の54\%）が確保されており，蓄電池容量860kWhが需要に対して相対的に大きいためである．特に2月はピークカット率79.3\%と最高値を記録した．

    \item \textbf{夏季（6--8月）の蓄電池効果が最小}：ピークカット率16.1\%（年間最低）に留まった．夏季は需要307.0MWhと年間最大である一方，PV発電は69.3MWh（需要の23\%）に過ぎない．8月は需要118.2MWhに対しPV発電18.8MWhと最も需給バランスが悪く，蓄電池容量860kWhでは需要ピークを十分に抑制できない．

    \item \textbf{PV発電量の季節パターン}：3月が32.4MWhで最大，8月が18.8MWhで最小となった．これは，(1) 太陽高度が高すぎると発電効率が低下すること，(2) 夏季は曇天・雨天日が多いこと，(3) パネル温度上昇による効率低下，などが要因として考えられる．

    \item \textbf{契約電力への示唆}：年間最大買電ピークは1月に発生（177.2kW）した．これは，最も寒冷な時期に暖房需要がピークとなり，PV発電（20.9MWh/月）では賄いきれないためである．買電ピークは冬季の暖房需要により決定されることが示唆される．

    \item \textbf{蓄電池サイクル数}：年間推定218サイクル（月平均18サイクル）であり，一般的なリチウムイオン電池の寿命（3,000〜6,000サイクル）に対して十分な余裕がある．
\end{enumerate}

図\ref{fig:monthly_analysis}に月別エネルギー量とピークカット率のグラフを示す．

\begin{figure}[H]
    \centering
    \includegraphics[width=0.95\textwidth]{../png/soc860/monthly_analysis.png}
    \caption{月別エネルギー量と蓄電池効果の分析}
    \label{fig:monthly_analysis}
\end{figure}

\subsection{市場価格（JEPX）の季節変動分析}

北海道電力基本プランが市場価格連動プランより有利となる理由を明らかにするため，JEPXスポット価格の季節変動を分析した．表\ref{tab:price_seasonal}に季節別，表\ref{tab:price_monthly}に月別の価格統計を示す．

\begin{table}[H]
\centering
\caption{季節別市場価格統計（北海道電力基本プラン21.51円/kWhとの比較）}
\label{tab:price_seasonal}
\begin{tabular}{lrrrrr}
\toprule
季節 & 平均 [円/kWh] & 中央値 [円/kWh] & 最大 [円/kWh] & 標準偏差 [円/kWh] & $>$北電率 [\%] \\
\midrule
春（3--5月） & 15.31 & 15.85 & 40.57 & 5.28 & 10.0 \\
夏（6--8月） & 18.10 & 17.31 & 33.98 & 4.40 & 24.9 \\
秋（9--11月） & 18.93 & 18.25 & 53.63 & 5.21 & 32.5 \\
冬（12--2月） & 15.12 & 14.25 & 26.98 & 3.54 & 6.4 \\
\midrule
年間 & 16.87 & 16.41 & 53.63 & 4.96 & 18.5 \\
\bottomrule
\end{tabular}
\end{table}

\noindent
ここで，「$>$北電率」は市場価格が北海道電力基本プランの電力量料金（21.51円/kWh）を上回る時間帯の割合を示す．

\begin{table}[H]
\centering
\caption{月別市場価格統計}
\label{tab:price_monthly}
\begin{tabular}{lrrrrrr}
\toprule
月 & 平均 [円/kWh] & 中央値 [円/kWh] & 最小 [円/kWh] & 最大 [円/kWh] & $>$北電率 [\%] & スパイク回数 \\
\midrule
1月 & 14.07 & 13.79 & 3.99 & 23.10 & 0.4 & 0 \\
2月 & 13.42 & 13.00 & 3.99 & 25.22 & 1.9 & 2 \\
3月 & 15.94 & 15.79 & 3.99 & 40.57 & 11.4 & 16 \\
4月 & 14.30 & 15.52 & 3.99 & 23.98 & 4.4 & 0 \\
5月 & 15.67 & 16.03 & 3.99 & 25.88 & 14.0 & 4 \\
6月 & 16.72 & 16.52 & 3.99 & 25.75 & 15.4 & 12 \\
7月 & 18.39 & 17.48 & 3.99 & 33.98 & 26.1 & 124 \\
8月 & 19.15 & 19.62 & 8.99 & 25.31 & 32.8 & 60 \\
9月 & 19.27 & 17.98 & 3.99 & 53.63 & 30.3 & 104 \\
10月 & 18.75 & 18.05 & 3.99 & 42.98 & 37.6 & 30 \\
11月 & 18.78 & 18.45 & 6.98 & 25.30 & 29.4 & 30 \\
12月 & 17.70 & 18.09 & 4.00 & 26.98 & 16.4 & 18 \\
\bottomrule
\end{tabular}
\end{table}

\noindent
「スパイク回数」は25円/kWh以上の価格が発生した30分コマ数を示す．年間最高価格53.63円/kWhは2024年9月20日9:00に発生した．

市場価格分析から，以下の知見が得られた：

\begin{enumerate}
    \item \textbf{市場価格の年間平均は北海道電力より低い}：年間平均16.87円/kWhは北海道電力基本プラン（21.51円/kWh）より\textbf{21.6\%安い}．しかし，この単純比較は買電タイミングを考慮していない．

    \item \textbf{市場価格が北海道電力を上回る時間帯は18.5\%}：年間17,520コマのうち3,236コマで市場価格が21.51円/kWhを超過する．特に秋季（9--11月）は32.5\%と最も高く，冬季（12--2月）は6.4\%と最も低い．

    \item \textbf{価格スパイクの季節集中}：25円/kWh以上の価格スパイクは年間400回（2.3\%）発生し，7月（124回），9月（104回），8月（60回）に集中している．これは冷房需要増加による電力逼迫を反映している．

    \item \textbf{価格スパイクの時間帯集中}：スパイクは9:00--14:00に集中しており（上位5時間帯で全体の57.5\%），昼間のピーク需要時間帯と一致する．この時間帯は需要も高いため，市場価格連動プランでは高価格での買電が避けられない．

    \item \textbf{時間帯別価格パターン}：深夜（0:00--2:00）は平均11--12円/kWh，昼間ピーク（11:00--14:00）は平均20--21円/kWhと，約2倍の価格差がある．市場価格連動プランはこの価格差を利用した時間シフトが可能だが，需要パターンとの制約により完全な活用は困難である．
\end{enumerate}

\subsubsection{北海道電力基本プランが有利となる理由}

以上の分析から，北海道電力基本プランが市場価格連動プランより年間約64万円安価となる理由は以下のように説明できる：

\begin{enumerate}
    \item \textbf{価格スパイク回避の困難さ}：市場価格連動プランでは，需要ピーク時（昼間）に価格スパイクが発生するため，高価格での買電が避けられない．蓄電池による時間シフトを行っても，夏季・秋季の需要が蓄電池容量（860kWh）を大きく上回るため，スパイク回避には限界がある．

    \item \textbf{契約電力の増加}：市場価格連動プランでは安価な時間帯に集中的に買電・充電するため，買電ピークが上昇し契約電力が増加する（北海道電力170.93kW vs 市場連動221.56kW）．基本料金の差額（約190万円/年）が電力量料金の差額を相殺する．

    \item \textbf{季節変動との相性}：冬季（12--2月）は市場価格が最も低く（平均15.12円/kWh），かつ蓄電池効果が最も高い（ピークカット率64.3\%）季節である．しかし，この時期は需要も低いため，市場価格連動プランのメリットが限定的となる．夏季・秋季は市場価格が高く，かつ蓄電池効果が低いため，市場価格連動プランに不利に働く．
\end{enumerate}

図\ref{fig:price_seasonal_analysis}に市場価格の季節変動と北海道電力基本プランとの比較を示す．

\begin{figure}[H]
    \centering
    \includegraphics[width=0.95\textwidth]{../png/soc860/price_seasonal_analysis.png}
    \caption{市場価格（JEPX）の季節変動分析}
    \label{fig:price_seasonal_analysis}
\end{figure}

\subsection{PV・蓄電池システムの効果}

PV・蓄電池システムの導入により，以下の効果が確認された：

\begin{enumerate}
    \item \textbf{PV自家消費}：PV発電量287,633kWhの100\%を自家消費し，総需要812,982kWhの35.4\%をPVで賄った（両プラン共通）．
    \item \textbf{PV利用率}:PV発電量287,633kWhのうち100\%を自家消費し,完全なPV利用率を達成した（両プラン共通）.
    \item \textbf{需要の平準化}：北海道電力基本プランでは，蓄電池により買電電力の変動を抑制し，契約電力を170.93kWに抑制できた．
\end{enumerate}

\subsection{制約条件の影響とPV余剰電力}

\begin{enumerate}
    \item \textbf{売電禁止の影響と蓄電池の役割}：売電ができない制約下で，蓄電池860kWhの導入によりPV利用率100\%を達成した（両プラン共通）．

    蓄電池の具体的な貢献を定量化すると，蓄電池なし（0kWh）の場合はPV利用率78.01\%（年間PV余剰63,240kWh）であったのに対し，蓄電池860kWhでPV利用率100\%（余剰ゼロ）を達成した．すなわち，蓄電池は年間\textbf{63,240kWh}（PV発電量287,633kWhの\textbf{22\%}に相当）の時間的ミスマッチを解消した．

    ただし，この結果の解釈には注意が必要である．年間でPV発電が瞬時需要を上回る時間帯は全体の16.0\%（2,797ステップ）に過ぎず，残りの84\%の時間帯ではPV発電は蓄電池がなくても需要により自然消費される．したがって，PV利用率100\%の達成は，(1) 需要がPV発電量の約2.8倍あるという本システムの構造的特性と，(2) 蓄電池による22\%分の時間シフト機能の組み合わせによる結果であり，蓄電池の「高度な制御」のみに帰するものではない．

    図\ref{fig:pv_curtailment}に，需要が少なく満充電に到達した代表的な日（2024年2月25日）の運用パターンを示す．この日は需要1,121kWh，PV発電979kWh，買電420kWhで，13:30に満充電（817kWh）に到達した．満充電到達後も，一部の時間帯（2ステップ，約28kWh分）でPV発電が需要を上回ったが，蓄電池からの放電により需給バランスを維持し，PV余剰の発生を回避した．この日の需要は年間平均（2,227kWh）の約半分であり，満充電到達日の中でも最も需要が少ない日である．

\begin{figure}[H]
    \centering
    \includegraphics[width=0.95\textwidth]{../png/soc860/pv_curtailment_pattern.png}
    \caption{需要が少なく満充電に到達した日の運用パターン（2024年2月25日，需要1,121kWh）}
    \label{fig:pv_curtailment}
\end{figure}

    \item \textbf{PV余剰調整機能の効果}：PV発電の不等号制約（$g_{\mathrm{P2}} \leq g_{\mathrm{P1}}$）により，必要最小限のPV余剰を自動的に調整できる．

    \item \textbf{契約電力の抑制}：目的関数に契約電力を組み込むことで，北海道電力基本プランでは最大買電電力を170.93kWに抑制できた．一方，市場価格連動プランでは電力価格が安い時間帯に買電を集中させるため，契約電力が221.56kWまで増加した．

    \item \textbf{蓄電池容量の妥当性}：860kWhの蓄電池容量は1日の需要変動（平均92.8kW，最大538.78kW）に対して適切であり，充放電出力400kWも需要ピークに対応可能である．
\end{enumerate}

\subsection{基本料金係数の按分手法に関する限界と結果への影響}
\label{sec:wbasic_limitation}

本研究で採用した基本料金係数$w_{\mathrm{basic}}$の按分手法には，数理的な限界が存在する．本節では，この限界が結果に与える影響を分析し，結論の解釈における注意点を明確にする．

\subsubsection{按分手法の数理的問題}

契約電力（基本料金の決定要因）は，本来「年間17,520ステップの中の最大買電電力」という\textbf{大域的な指標}で決定される．しかし，ローリング計画法では年間を通した最適化が計算上困難であるため，本研究では各予測期間（96ステップ，48時間）内の最大値$s^{\mathrm{BY}}_{\mathrm{MAX}}$に按分係数$w_{\mathrm{basic}}$を乗じてペナルティを与える近似を採用した．

この「局所的な最大値の抑制」を通じて「大域的な最大値」を間接的に制御する手法には，以下の数理的問題がある：

\begin{enumerate}
    \item \textbf{最適化基準と評価基準の乖離}：ソルバーは各予測期間で「$w_{\mathrm{basic}} \times s^{\mathrm{BY}}_{\mathrm{MAX}}$」を最小化しようとするが，最終的な基本料金は「年間最大買電電力 × 単価」で計算される．この二重基準により，最適化時の判断が必ずしも年間コスト最小化に直結しない．

    \item \textbf{局所最適と大域最適の不一致}：ある予測期間でピークを抑制する努力が，別の期間で発生するより大きなピークにより無効化される可能性がある．逆に，ある期間でピークを許容しても，それが年間最大値とならなければ基本料金には影響しない．

    \item \textbf{按分係数の重みの影響}：$w_{\mathrm{basic}}$の値は実際の料金単価から導出しているが，この係数が「最適化問題において適切なペナルティとして機能するか」は別問題である．係数の値によって，ソルバーの「ピーク抑制」と「電力量料金削減」のトレードオフ判断が変化する．
\end{enumerate}

\subsubsection{料金プラン別の影響分析}

\noindent
\textbf{北海道電力基本プランへの影響（限定的）}：

北海道電力基本プランでは電力量料金が一定（21.51円/kWh）であるため，ソルバーにとって「いつ買電するか」は電力量料金の観点からは無差別である．したがって，目的関数において$w_{\mathrm{basic}} \times s^{\mathrm{BY}}_{\mathrm{MAX}}$の項が相対的に支配的となり，ソルバーは自然に買電電力を平準化する方向に最適化を行う．

この結果，各予測期間の最大買電電力が類似した値に収束し，「局所的な最大値」と「大域的な最大値（年間契約電力）」の乖離が小さくなる．表\ref{tab:capacity_comparison_detail}において，北海道電力基本プランの契約電力が蓄電池容量に対して一貫して減少している（267.35kW→161.16kW）のは，この按分手法が比較的有効に機能していることを示唆する．

\noindent
\textbf{市場価格連動プランへの影響（顕著）}：

市場価格連動プランではJEPX価格が時間帯により大きく変動する（2024年実績：3.80〜31.00円/kWh，約8倍）．この価格変動により，ソルバーには「価格が安い時間帯に買電を集中させる」という強いインセンティブが働く．

具体的に，価格が5円/kWhの時間帯と25円/kWhの時間帯では，20円/kWhの差がある．一方，按分係数$w_{\mathrm{basic}} \approx 158$円/kW（予測期間あたり）は，ピーク1kWの増加に対するペナルティとして，この価格差と比較される．ソルバーは以下のトレードオフを評価する：

\begin{itemize}
    \item \textbf{安値買電のメリット}：価格差20円/kWh × 買電量
    \item \textbf{ピーク増加のデメリット}：$w_{\mathrm{basic}}$ × ピーク増加量
\end{itemize}

大容量蓄電池（例：1720kWh）を持つ場合，安値時間帯に大量の買電・充電が可能となり，「安値買電のメリット」が「ピーク増加のデメリット」を上回るケースが増加する．これが，市場価格連動プランで蓄電池容量増加に伴い契約電力が増大した（430kWh: 205.73kW → 1720kWh: 232.94kW）原因と考えられる．

\subsubsection{結論の解釈における注意点}

以上の分析から，本研究の結論を解釈する際には以下の点に注意が必要である：

\begin{enumerate}
    \item \textbf{市場価格連動プランの最適蓄電池容量}：「430kWhで最小コスト」という結果は，$w_{\mathrm{basic}}$の現在の設定値に依存している可能性がある．按分係数を変化させた感度分析は実施していないため，この最適容量の頑健性は検証されていない．

    \item \textbf{契約電力の増加現象}：市場価格連動プランで蓄電池容量増加に伴い契約電力が増大する現象は，(a) 市場価格変動を活用した時間的裁定という本質的な特性と，(b) 按分手法の限界による人工的な影響の両方が寄与している可能性がある．両者を完全に分離することは本研究の範囲では困難である．

    \item \textbf{両プランの比較}：北海道電力基本プランと市場価格連動プランの比較において，前者は按分手法の影響を受けにくく，後者は影響を受けやすいという非対称性がある．したがって，「北海道電力基本プランが約53万円安価」という結論は，この手法的限界を考慮して解釈する必要がある．
\end{enumerate}

\noindent
\textbf{今後の課題}：按分手法の限界を克服するためには，(1) $w_{\mathrm{basic}}$を変化させた感度分析，(2) 年間を通した契約電力の明示的な追跡機構の導入，(3) 異なる最適化手法（例：年間最大値を制約として扱う手法）との比較検証が必要である．これらは今後の研究課題とする．

\section{まとめ}

北海道十勝地方のPV・蓄電池システム（PV容量250kW）を対象に，ローリング計画法による年間電気料金の最小化を実施した．蓄電池容量を0kWh〜1720kWhの範囲で変化させ，北海道電力基本プランと市場価格連動プランの経済性を比較した．対象期間は2024年1月1日から12月31日（2月29日を除く365日，17,520ステップ）である．主な結果は以下の通りである：

\begin{enumerate}
    \item \textbf{料金プランの有利性は蓄電池容量に依存}：蓄電池容量430kWh以下では市場価格連動プランが有利，540kWh以上では北海道電力基本プランが有利となる．この逆転点（430kWh〜540kWh）は，両プランの契約電力特性の違いに起因する．

    \item \textbf{各プランの最適蓄電池容量}：
    \begin{itemize}
        \item 市場価格連動プラン：430kWhで最小コスト（\textbf{15,007,684円}）を達成
        \item 北海道電力基本プラン：1720kWhで最小コスト（\textbf{14,476,495円}）を達成
    \end{itemize}

    \item \textbf{公平な比較による結論}：各プランにとって最適な蓄電池容量で比較した場合でも，北海道電力基本プラン＋1720kWhが市場価格連動プラン＋430kWhより\textbf{約53万円安価}である．したがって，蓄電池容量の選択を含めた総合評価においても，北海道電力基本プランが経済的に有利である．

    \item \textbf{契約電力特性の違い}：北海道電力基本プランでは蓄電池容量増加に伴い契約電力が一貫して減少（ピークカット効果）するのに対し，市場価格連動プランでは430kWh以降は容量増加に伴い契約電力が増加する（価格が安い時間帯への買電集中）．

    \item \textbf{蓄電池導入効果}：蓄電池なし（0kWh）と比較して，北海道電力基本プラン＋1720kWhで年間約404万円，市場価格連動プラン＋430kWhで年間約282万円のコスト削減を達成．PV利用率は860kWh以上で100\%を達成した．

    \item \textbf{予測期間の影響}：48時間先（96ステップ）の予測期間が計算時間と削減効果のバランスから実用的な選択である．72時間予測では追加削減効果が逓減する．
\end{enumerate}

\noindent
\textbf{注記}：本研究では2024年1月1日から12月31日のデータを使用したが，2月29日（閏日）は欠損しているため，実質的には365日分（17,520ステップ）のデータに基づく分析である．

\end{document}
