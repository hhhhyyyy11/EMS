# PV・蓄電池システムにおけるローリング計画法を用いた電気料金最小化：実装詳細ドキュメント

本ドキュメントは、北海道十勝地方のPV・蓄電池システムにおける年間電気料金最小化を目的とした、数理モデルおよびシミュレーションアルゴリズムの実装詳細を規定するものである。

## 1. システム構成と対象データ

### 1.1 導入システムの仕様

* **対象期間**: 2024年1月1日〜12月31日（2月29日を除く365日間、計17,520ステップ）
* **時間分解能**: 30分間隔（1ステップ = 0.5時間）
* **太陽光発電（PV）システム**: 250 kW（南向き、設置角度40°）
* **蓄電池システム**:
  * **容量 ($bmax_F$)**: **可変パラメータ**とし、容量変化が経済性に与える影響を評価する。
  * **最大充放電出力**: 400 kW
  * **充放電効率**: 充電・放電・需要変換ともに 0.98（仮定値）
  * **SOC初期値**: 容量の50%

### 1.2 使用データ

* **消費電力・PV発電量**: 2024年の実測30分値データ。単位は電力 [kW] に変換して使用。
* **市場価格（JEPX）**: 日本卸電力取引所のスポット価格データ [円/kWh]。

---

## 2. 数理モデルの定式化

混合整数線形計画法（MILP）を用い、PySCIPOptソルバーにより各ステップの最適解を算出する。

### 2.1 決定変数

* $sBY_k$: 時刻 $k$ における買電量 [kW]
* $sBY_{MAX}$: 予測期間内の最大買電量（契約電力） [kW]
* $bF_k$: 時刻 $k$ における蓄電池残存電力量（SOC） [kWh]
* $z_k$: 充放電の選択を制御する二値変数（1=充電可能、0=放電可能）

### 2.2 目的関数

予測期間 $H=96$（48時間先）における基本料金コストと電力量料金の合計を最小化する。
$$Minimize \quad w_{basic} \cdot sBY_{MAX} + \sum_{k=0}^{H-1} pBY_k \cdot sBY_k \cdot 0.5$$
ここで、$w_{basic}$ は年間の基本料金単価を予測期間の長さに按分した係数である：
$$w_{basic} = \frac{2829.60 \times 0.85 \times 12 \times H \times 0.5}{24 \times 366}$$

### 2.3 制約条件

1. **電力収支**: PV使用量 + 買電量 + 放電量 = 需要 + 充電量
2. **PV利用制限**: 実際に使用するPV電力は、気象データによる発電可能量を超えない（余剰の自動調整）。
3. **SOC更新**: $SOC_k = SOC_{k-1} + (充電電力 \cdot 効率 - 放電電力 / 効率) \cdot 0.5$
4. **SOC範囲制約**: **$0.05 \cdot bmax_F \le SOC_k \le 0.95 \cdot bmax_F$**
    * 蓄電池の劣化抑制のため、全容量の5%〜95%の範囲内で運用する。
5. **充放電出力制約**: 充電・放電ともに最大 400 kW を上限とする。
6. **非同時充放電**: 二値変数 $z_k$ と十分大きな定数 $M$（$10^6$）を用いたBig-M法により、充電と放電が同一時刻に発生することを禁止する。
7. **売電禁止**: 逆潮流を認めず、売電量は常に 0 とする。
8. **契約電力制約**: 全ての時刻 $k$ において買電量 $sBY_k \le sBY_{MAX}$。

---

## 3. アルゴリズムと実行プロセス

### 3.1 ローリング計画法

本システムは、1年間の最適化を以下のステップで逐次的に実行する：

1. 現在時刻 $k$ から48時間先（96ステップ）のデータを取得。
2. 上記数理モデルに基づき、予測期間内の最適スケジュールを算出。
3. **最初の1ステップ（30分分）の制御指示のみを実行**し、蓄電池のSOCを更新。
4. 時刻を1ステップ進め、最新のシステム状態（SOC等）を初期値として手順1へ戻る。
