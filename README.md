# PV・蓄電池システムにおけるローリング計画法を用いた電気料金最小化：実装詳細ドキュメント

本ドキュメントは、北海道十勝地方のPV・蓄電池システムを対象としたエネルギーマネジメントシステム（EMS）のシミュレーション実装仕様を定義するものである。 目的は、ローリング計画法を用いた混合整数線形計画法（MILP）により、年間電気料金を最小化する運用手法を確立し、各種パラメータ（料金プラン、予測期間、設備容量）が運用結果に与える影響を比較検証することである。

## 1. システム要件と前提条件

### 1.1 開発環境

* **言語**: Python 3.x
* **ソルバー**: PySCIPOpt (SCIP Optimization Suite)
* **ライブラリ**: pandas, numpy, matplotlib

### 1.2 対象システム仕様 (Base Case)

* **対象期間**: 2024年1月1日〜12月31日（2月29日を除く365日間、計17,520ステップ）
* **時間分解能**: 30分間隔（1ステップ = 0.5時間）
* **太陽光発電（PV）システム**: 250 kW（南向き、設置角度40°）
* **蓄電池システム**:
  * **容量 ($bmax_F$)**: **可変パラメータ**とし、容量変化が経済性に与える影響を評価する。
  * **最大充放電出力**: 400 kW
  * **充放電効率**: 充電・放電・需要変換ともに 0.98
  * **SOC初期値**: **各容量ケースにおける容量の50%** ($0.5 \times bmax_F$)
* **電力系統**:
  * 売電: 不可（逆潮流禁止, 売電量=0）
  * 力率割引: 85%

### 1.3 入力データ

* **消費電力・PV発電量**: 2024年の実測30分値データ。単位は電力 [kW] に変換して使用。
* **市場価格（JEPX）**: 日本卸電力取引所のスポット価格データ [円/kWh]。

---

## 2. 数理モデルの定式化 (MILP)

混合整数線形計画法（MILP）を用い、PySCIPOptソルバーにより各ステップの最適解を算出する。

### 2.1 決定変数

* $s_{k}^{BY} \ge 0$: 時刻 $k$ における買電電力 [kW]
* $s_{MAX}^{BY} \ge 0$: 予測期間内の最大買電電力（契約電力相当）[kW]
* $b_{k}^{F} \ge 0$: 時刻 $k$ における蓄電池SOC [kWh]
* $x_{k}^{FC1}, x_{k}^{FC2} \ge 0$: 充電電力（変換前/変換後）[kW]
* $x_{k}^{FD1}, x_{k}^{FD2} \ge 0$: 放電電力（変換前/変換後）[kW]
* $g_{k}^{P2} \ge 0$: 実際に使用するPV発電電力 [kW]
* $z_{k} \in \{0, 1\}$: 充電・放電状態を表すバイナリ変数 (1=充電可, 0=放電可)

### 2.2 目的関数

予測期間 $H$（ステップ数）における「基本料金項」と「電力量料金項」の総和を最小化する。

$$
\text{Minimize} \quad w_{basic} \cdot s_{MAX}^{BY} + \sum_{k=0}^{H-1} p_{k}^{BY} \cdot s_{k}^{BY} \cdot 0.5
$$

ここで、基本料金の重み係数 $w_{basic}$ は、年間の基本料金単価を予測期間長に合わせて按分したものである：
$$
w_{basic} = \frac{2829.60 \times 0.85 \times 12 \times (H \times 0.5)}{24 \times 365}
$$

* $2829.60$: 基本料金単価 [円/kW]
* $0.85$: 力率割引
* $p_{k}^{BY}$: 時刻 $k$ の電力量単価（市場連動または固定単価）

### 2.3 制約条件

## 1. 電力需給バランス

$$
g_{k}^{P2} + s_{k}^{BY} + x_{k}^{FD2} = d_{k}^{A2} + x_{k}^{FC1}
$$

* $d_{k}^{A2}$: 需要電力（効率考慮後）

## 2. PV出力抑制（余剰処理）

$$
g_{k}^{P2} \le g_{k}^{P1} \quad (\text{発電可能量})
$$

## 3. 蓄電池SOC更新式

$$
b_{k}^{F} = b_{k-1}^{F} + (x_{k}^{FC2} - x_{k}^{FD1}) \times 0.5
$$
$$
x_{k}^{FC2} = 0.98 \times x_{k}^{FC1}, \quad x_{k}^{FD2} = 0.98 \times x_{k}^{FD1}
$$

## 4. SOC運用範囲制約

蓄電池劣化抑制のため、容量の5%〜95%の範囲で運用する。
$$
0.05 \cdot b_{F}^{max} \le b_{k}^{F} \le 0.95 \cdot b_{F}^{max}
$$
※ $b_{F}^{max}$ はパラメータとして与えられる（標準は860 kWh）。

## 5. 充放電出力制約

$$
0 \le x_{k}^{FC2} \le 400, \quad 0 \le x_{k}^{FD1} \le 400
$$

## 6. 同時充放電禁止 (Big-M法)

$$
x_{k}^{FC1} \le M \cdot z_{k}
$$
$$
x_{k}^{FD1} \le M \cdot (1 - z_{k})
$$
($M = 10^6$)

## 7. 契約電力制約

$$
s_{k}^{BY} \le s_{MAX}^{BY} \quad (\forall k \in 0 \dots H-1)
$$

## 8. 売電禁止制約

$$
s_{k}^{SL} = 0
$$

---

## 3. アルゴリズム（ローリング計画法）

1. **初期化**: 時刻 $t=0$, 初期SOC $b_{0}^{F} = 0.5 \times b_{F}^{max}$
2. **予測データの取得**: 現在時刻から $H$ ステップ先までの需要・発電・価格データを取得。
3. **最適化実行**: 上記MILPモデルを解き、最適な制御列を算出。
4. **実行と更新**:
    * 算出した**最初の1ステップ分**の制御（充放電・買電）のみを確定値として記録。
    * 実際のSOCを更新。
5. **時間の進行**: $t \leftarrow t+1$ とし、期間終了まで繰り返す。

---

## 4. 比較検証シナリオ（Simulation Scenarios）

本研究では、以下のパラメータを変化させ、それぞれの運用結果（コスト、自給率、SOC挙動）を比較検証するコードを実装すること。

### シナリオA：料金プランの比較

予測期間 $H=96$ (48時間)、蓄電池容量 $860$ kWh の条件下で、以下の2つの料金体系でシミュレーションを行う。

1. **北海道電力 基本プラン**: 固定単価 + 燃料費調整額
2. **市場価格連動プラン**: JEPXスポット価格 + 再エネ賦課金

### シナリオB：予測期間（ホライズン）の影響比較

市場価格連動プラン、蓄電池容量 $860$ kWh の条件下で、予測期間 $H$ を変化させて比較する。

1. **短期予測**: $H=48$ (24時間先)
2. **長期予測**: $H=96$ (48時間先)
    * *検証項目*: PV余剰の発生有無、満充電到達回数、契約電力値の違い。

### シナリオC：蓄電池容量（SOC最大値）の比較検証

市場価格連動プラン、予測期間 $H=96$ (48時間) の条件下で、**蓄電池容量 $b_{F}^{max}$ を変化させて比較する**。

* **比較範囲**: $0$ kWh 〜 $2000$ kWh 程度の範囲で、適切な刻み幅（例: 100kWhまたは200kWh）にて実施。
* *注意*: 容量が変わるため、SOC制約の上下限（5%〜95%）および初期値（50%）も動的に変更する必要がある。
* *目的*: 設備容量の変化が経済性（年間コスト）およびPV自給率に与える影響を感度解析として評価する。

---

## 5. 出力データと可視化要件

各シナリオの実行結果として、以下のデータおよびグラフを出力・保存する機能を実装すること。

### 5.1 時系列ログ (CSV)

全ステップ（17,520行）の運用詳細データ。

* 日時, 需要, PV発電量, PV使用量, 買電量, 蓄電池充放電量, SOC, 電気料金単価

### 5.2 集計データ (Summary)

各シナリオ・各ケースごとの年間合計値をまとめた表。

* 年間総コスト [円]（内訳：基本料金、電力量料金）
* 年間総買電量 [kWh]
* 年間最大買電電力（契約電力） [kW]
* PV自給率 [%], PV利用率 [%]
* 平均SOC [%], 満充電到達回数

### 5.3 グラフ出力 (Images)

論文掲載用として以下のプロットを作成する。

1. **年間推移グラフ**: 需要・PV・買電の時系列（図1相当）
2. **SOC推移グラフ**: 年間のSOC変動（図2相当）
3. **1日詳細グラフ**:
    * 需要が高い日の「PV多い日 vs 少ない日」比較（図3相当）
    * 需要が低い日の「PV多い日 vs 少ない日」比較（図4相当）
4. **比較分析グラフ**:
    * 容量（横軸） vs コスト（縦軸）の相関曲線
    * 容量（横軸） vs PV自給率（縦軸）の相関曲線

---

### 補足：実装上の注意点

* **基本料金の事後計算**: 最適化ループ内では近似的な重み係数 $w_{basic}$ を使用するが、最終的な「年間電気料金」の算出においては、シミュレーション全期間を通じた**最大買電電力（ピーク値）**に基づき、正規の基本料金計算式（$P_{max} \times 2829.60 \times 0.85 \times 12$）を用いて再計算すること。
* **初期SOC**: ループ開始時（1月1日00:00）のSOCは容量の50%とするが、ローリング計画の各ステップにおける初期値は前ステップの最終SOCを用いる。
